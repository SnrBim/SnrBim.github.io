# Руководство по работе с командой "Синхронизация схемы пожарной сигнализации"

## 1. Назначение команды

Команда предназначена для автоматического создания и последующей синхронизации 2D-схемы расположения устройств пожарной сигнализации на основе 3D-модели. Она генерирует на чертежном виде 2D-элементы, соответствующие помещениям и устройствам, и отслеживает изменения в модели, обновляя схему.

## 2. Подготовка к работе

1.  **Архитектурная модель:** В проект должна быть подгружена связанная модель (Revit Link) с архитектурными помещениями (`Rooms`).
2.  **Активный вид:** Перед запуском команды необходимо открыть **чертежный вид** (`Drafting View`), на котором будет размещаться схема.

## 3. Шаг 1: Выбор исходных данных

При запуске команды открывается диалоговое окно, в котором необходимо указать исходные данные для синхронизации.

*   **Архитектурная связь:**
    *   В выпадающем списке представлены все связанные файлы Revit, в которых найдены помещения.
    *   Список автоматически отсортирован: приоритет отдается связям, в имени которых есть "AR", а затем — по убыванию количества помещений. Как правило, нужная связь уже выбрана по умолчанию.

*   **Уровни для синхронизации:**
    *   После выбора связи в списке ниже отображаются все уровни из этой связи, на которых были найдены устройства пожарной сигнализации.
    *   Для каждого уровня указано общее количество помещений и устройств, которые в них находятся.
    *   Вы можете выбрать один или несколько уровней для обработки, установив галочки напротив них.

## 4. Шаг 2: Процесс синхронизации

После нажатия кнопки "OK" начинается процесс создания и обновления 2D-схемы на активном чертежном виде.

*   **Создание 2D-помещений:**
    *   Для каждого помещения из выбранных уровней, в котором есть хотя бы одно устройство, на схеме создается 2D-рум (семейство "Room").
    *   Если 2D-рум для такого помещения уже существует на схеме, новый не создается, а обновляется существующий.
    *   **Ширина рума** рассчитывается автоматически в зависимости от максимального количества устройств в одном из двух рядов (см. ниже), чтобы все они поместились. Минимальная ширина рума — 40 мм.
    *   В параметры 2D-рума записываются **Номер**, **Имя** и **Уровень** из исходного 3D-помещения.

*   **Создание 2D-устройств:**
    *   Внутри каждого 2D-рума помещения размещаются 2D-символы устройств (семейство "Fire alarm 2d") в соответствии с их 3D-прототипами.
    *   **Расположение:** Устройства размещаются в **два ряда**:
        1.  **Верхний ряд (датчики):** `Pull Station`, `Heat detector`, `Smoke detector`.
        2.  **Нижний ряд (оповещатели и ИПР):** `Strobe`, `Horn strobe`, `Horn`.
    *   В параметры 2D-устройства записываются:
        *   `Code`: Копируется из параметра `Mark` 3D-устройства.
        *   `Room`: Номер и имя помещения.
        *   `RoomLevel`: Имя уровня помещения.

## 5. Результат и цветовая индикация

После синхронизации элементы на схеме окрашиваются в разные цвета в зависимости от их статуса. Это позволяет быстро оценить, какие изменения произошли в модели.

*   **Черный (стандартный цвет):**
    *   Новое 2D-помещение и все устройства в нем, созданные впервые.

*   **Зеленый:**
    *   Новое 2D-устройство, которое было добавлено в уже существующее на схеме 2D-помещение.

*   **Оранжевый:**
    *   **Данные обновлены.** Элемент окрашивается в этот цвет, если:
        *   У помещения изменился номер или имя.
        *   У 3D-устройства был изменен тип (например, `Smoke detector` заменен на `Heat detector`).

*   **Фиолетовый:**
    *   **Элемент перемещен.** Если 3D-устройство было перемещено из одного помещения в другое, его 2D-символ на схеме также перемещается в соответствующий рум и окрашивается в фиолетовый.

*   **Красный:**
    *   **"Осиротевший" элемент.** Если исходный 3D-элемент (помещение или устройство) был удален из модели, его 2D-представление на схеме остается, но окрашивается в красный цвет. Это сигнал о том, что элемент на схеме больше не связан с моделью.

## 6. Отслеживание изменений (Параметр "Sync info")

Каждый 2D-элемент на схеме (и помещение, и устройство) имеет текстовый параметр **"Sync info"**. В него автоматически записывается история всех изменений, которые с ним происходили в процессе синхронизации, с указанием даты и времени.

*Пример записи: "Перемещен из '101 - Office' в '102 - Corridor' [2025-10-28 14:30:15]"*

## 7. Известные ограничения

*   **Поиск помещений:** Поиск помещения производится с дополнительной проверкой на 200 мм выше и на 1000 мм ниже. В редких случаях, если устройства в 3D-модели расположены очень близко к полу и вне помещения, алгоритм может ошибочно определить принадлежность устройства к помещению на этаже ниже.
*   **Автоматическое изменение ширины помещений:** При изменении количества устройств в помещении его ширина на схеме будет автоматически скорректирована при следующей синхронизации.
*   **Отсутствие автоматического сдвига:** Скрипт **не сдвигает** соседние помещения, если одно из них расширилось. Это сделано для сохранения ручного расположения элементов на схеме. Если одно помещение начнет перекрывать другое, потребуется вручную выделить и сдвинуть соседние элементы.